{% extends "base.html" %}

{% block title %}{{ doce.nome }} - PastaArt Encanto{% endblock %}
{% block meta_description %}{{ (doce.descricao[:155] ~ ('...' if doce.descricao|length > 155 else '')) if doce.descricao else 'Doces personalizados artesanais feitos sob encomenda.' }}{% endblock %}
{% block og_title %}{{ doce.nome }} | PastaArt Encanto{% endblock %}
{% block og_description %}{{ (doce.descricao[:200] ~ ('...' if doce.descricao|length > 200 else '')) if doce.descricao else 'Doces artesanais exclusivos sob encomenda.' }}{% endblock %}
{% block og_type %}product{% endblock %}
{% block og_image %}{{ url_for('static', filename=(doce.imagem_url or 'images/banner.webp'), _external=True) }}{% endblock %}

{% block content %}
<section class="product-details">
    <div class="container">
        <nav class="breadcrumb">
            <a href="{{ url_for('loja.index') }}">Início</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ doce.nome }}</span>
        </nav>

        <div class="product-detail-content">
            <div class="product-image-section">
                {% if doce.imagem_url %}
                   <img src="{{ asset_url(doce.imagem_url) }}" alt="{{ doce.nome }}" class="product-detail-image" decoding="async">
                {% else %}
                    <div class="product-detail-placeholder">
                        <i class="fas fa-birthday-cake"></i>
                        <p>Imagem em breve</p>
                    </div>
                {% endif %}
            </div>

            <div class="product-info-section">
                <h1 class="product-detail-title">{{ doce.nome }}</h1>
                
                <div class="product-detail-price">
                    <span class="price-label">Preço:</span>
                    <span class="price-value">R$ {{ "%.2f"|format(doce.preco) }}</span>
                    {% if doce.unidade_venda == 'kit' and doce.desconto_percentual is not none and doce.desconto_percentual > 0 %}
                        {% set preco_cheio = (doce.preco / (1 - (doce.desconto_percentual / 100))) %}
                        <span class="card-price-old">R$ {{ '%.2f'|format(preco_cheio) }}</span>
                    {% endif %}
                    <div class="price-badges">
                        {% if doce.unidade_venda == 'kit' and doce.desconto_percentual is not none and doce.desconto_percentual > 0 %}
                        <span class="badge badge-discount badge-sm"><i class="fas fa-tag"></i> {{ '%.0f'|format(doce.desconto_percentual) }}% OFF</span>
                        {% endif %}
                    </div>
                </div>

                <div class="product-detail-description">
                    <h3>Descrição</h3>
                    <p>{{ doce.descricao }}</p>
                </div>

                {% if doce.unidade_venda == 'kit' and doce.kit_itens %}
                <div class="product-kit-section">
                    <h3>Itens que compõem este Kit</h3>
                    <ul class="kit-items-list elegant">
                        {% for item in doce.kit_itens %}
                            {% set subtotal = (item.quantidade * item.produto.preco) %}
                            <li class="kit-item">
                                <div class="kit-thumb">
                                    {% if item.produto.imagem_url %}
                                        <img src="{{ asset_url(item.produto.imagem_url) }}" alt="{{ item.produto.nome }}" loading="lazy">
                                    {% else %}
                                        <div class="kit-thumb-placeholder"><i class="fas fa-birthday-cake"></i></div>
                                    {% endif %}
                                </div>
                                <div class="kit-info">
                                    <div class="kit-name">{{ item.produto.nome }}</div>
                                    <div class="kit-meta">x{{ item.quantidade }} • R$ {{ '%.2f'|format(subtotal) }}</div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                    <small class="kit-note">Itens exibidos são fixos deste kit. As quantidades não podem ser alteradas.</small>
                </div>
                {% endif %}

                <!-- Novas Informações do Produto -->
                {% if doce.sabores %}
                <div class="product-flavors-section">
                    <h3>Sabores Disponíveis</h3>
                    <div class="flavors-grid">
                        {% for sabor in doce.get_sabores_list() %}
                            <label class="flavor-option">
                                <input type="radio" 
                                       name="sabor_selecionado" 
                                       value="{{ sabor.strip() }}" 
                                       class="flavor-radio"
                                       {% if loop.first %}checked{% endif %}>
                                <span class="flavor-badge">{{ sabor.strip() }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}



                {% if doce.quantidade_minima > 1 %}
                <div class="product-min-qty-section">
                    <h3>Quantidade Mínima</h3>
                    <p class="min-qty-info">
                        <i class="fas fa-info-circle"></i>
                        Pedido mínimo: {{ doce.quantidade_minima }} {{ doce.unidade_venda }}
                    </p>
                </div>
                {% endif %}

                <div class="product-actions-detail">
                    <form method="POST" action="{{ url_for('loja.adicionar_carrinho') }}" class="quantity-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="quantity-selector">
                            <label for="quantidade">Quantidade:</label>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn" onclick="decreaseQuantity()">-</button>
                                <input type="number" 
                                       id="quantidade" 
                                       name="quantidade" 
                                       value="{{ doce.quantidade_minima }}" 
                                       min="{{ doce.quantidade_minima }}" 
                                       max="50">
                                <button type="button" class="quantity-btn" onclick="increaseQuantity()">+</button>
                            </div>
                            {% if doce.quantidade_minima > 1 %}
                            <small class="quantity-hint">
                                Quantidade mínima: {{ doce.quantidade_minima }} {{ doce.unidade_venda }}
                            </small>
                            {% endif %}
                        </div>
                        
                        <input type="hidden" name="doce_id" value="{{ doce.id }}">
                        {% if doce.sabores %}
                        <input type="hidden" name="sabor_selecionado" id="sabor_selecionado_input" value="{{ doce.get_sabores_list()[0].strip() }}">
                        {% endif %}
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-primary btn-large">
                                <i class="fas fa-cart-plus"></i>
                                Adicionar ao Carrinho
                            </button>
                            
                            <a href="{{ request.referrer or url_for('loja.index') }}" class="btn btn-outline btn-large btn-continue-shopping">
                                <i class="fas fa-arrow-left"></i>
                                Continuar Comprando
                            </a>
                        </div>
                    </form>
                </div>

                <!-- Informações Adicionais -->
                <div class="product-extra-info">
                    <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <strong>Tempo de preparo:</strong>
                            <span>
                                {% if doce.categoria == 'personalizado' %}
                                    15 dias úteis
                                {% else %}
                                    1 a 2 dias úteis
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    {% if doce.categoria == 'personalizado' %}
                    <div class="info-item">
                        <i class="fas fa-palette"></i>
                        <div>
                            <strong>Personalização:</strong>
                            <span>Cores e detalhes combinados previamente</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="info-item">
                        <i class="fas fa-leaf"></i>
                        <div>
                            <strong>Ingredientes:</strong>
                            <span>Todos naturais e de alta qualidade</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
function increaseQuantity() {
    const input = document.getElementById('quantidade');
    const currentValue = parseInt(input.value);
    const minValue = parseInt(input.min) || 1;
    if (currentValue < 50) {
        input.value = currentValue + 1;
    }
}

function decreaseQuantity() {
    const input = document.getElementById('quantidade');
    const currentValue = parseInt(input.value);
    const minValue = parseInt(input.min) || 1;
    if (currentValue > minValue) {
        input.value = currentValue - 1;
    }
}

// Animação no botão de adicionar ao carrinho
document.querySelector('.quantity-form').addEventListener('submit', function() {
    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando...';
    btn.disabled = true;
    
    // Re-habilitar o botão após 2 segundos se não houver redirecionamento
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
});

// Validação da quantidade
document.getElementById('quantidade').addEventListener('input', function() {
    const value = parseInt(this.value);
    const minValue = parseInt(this.min) || 1;
    if (value < minValue) this.value = minValue;
    if (value > 50) this.value = 50;
});

// Atualizar sabor selecionado quando o usuário escolher
document.addEventListener('DOMContentLoaded', function() {
    const flavorRadios = document.querySelectorAll('.flavor-radio');
    const saborInput = document.getElementById('sabor_selecionado_input');
    
    if (flavorRadios.length > 0 && saborInput) {
        flavorRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                saborInput.value = this.value;
            });
        });
    }
    // Continuar Comprando: voltar para página anterior se mesma origem
    const continueBtn = document.querySelector('.btn-continue-shopping');
    if (continueBtn) {
        continueBtn.addEventListener('click', function(e) {
            try {
                if (document.referrer && new URL(document.referrer).origin === location.origin) {
                    e.preventDefault();
                    history.back();
                }
            } catch (err) {
                // ignora parsing errors
            }
        });
    }
});
</script>
{% endblock %}
