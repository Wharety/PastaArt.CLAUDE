{% extends "admin/base.html" %}

{% block title %}Pedido #{{ pedido.numero_pedido }} - Painel Administrativo{% endblock %}

{% block content %}
<div class="admin-page-header">
    <div class="page-header-content">
        <div class="page-title-section">
            <h1 class="admin-page-title">
                <i class="fas fa-shopping-cart"></i>
                Pedido #{{ pedido.numero_pedido }}
            </h1>
            <p class="admin-page-subtitle">Detalhes completos do pedido</p>
        </div>
        
        <div class="page-actions">
            <a href="{{ url_for('admin.listar_pedidos') }}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                Voltar aos Pedidos
            </a>
        </div>
    </div>
</div>

<div class="order-details-grid">
    <!-- Informações do Pedido -->
    <div class="order-info-card">
        <div class="card-header">
            <h3><i class="fas fa-info-circle"></i> Informações do Pedido</h3>
        </div>
        <div class="card-content">
            <div class="info-row">
                <span class="info-label">Número do Pedido:</span>
                <span class="info-value">#{{ pedido.numero_pedido }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Data do Pedido:</span>
                <span class="info-value">{{ pedido.data_pedido.strftime('%d/%m/%Y às %H:%M') }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Status:</span>
                <span class="status-badge status-{{ pedido.status }}">
                    {% if pedido.status == 'pendente' %}
                        <i class="fas fa-clock"></i>
                    {% elif pedido.status == 'preparando' %}
                        <i class="fas fa-cog"></i>
                    {% elif pedido.status == 'pronto' %}
                        <i class="fas fa-check"></i>
                    {% elif pedido.status == 'entregando' %}
                        <i class="fas fa-truck"></i>
                    {% elif pedido.status == 'concluido' %}
                        <i class="fas fa-check-circle"></i>
                    {% elif pedido.status == 'cancelado' %}
                        <i class="fas fa-times-circle"></i>
                    {% endif %}
                    {{ pedido.status|title }}
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Total:</span>
                <span class="info-value total-value">R$ {{ "%.2f"|format(pedido.total) }}</span>
            </div>
            {% if pedido.observacoes %}
            <div class="info-row">
                <span class="info-label">Observações:</span>
                <span class="info-value">{{ pedido.observacoes }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Informações do Cliente -->
    <div class="customer-info-card">
        <div class="card-header">
            <h3><i class="fas fa-user"></i> Informações do Cliente</h3>
        </div>
        <div class="card-content">
            <div class="info-row">
                <span class="info-label">Nome:</span>
                <span class="info-value">{{ pedido.usuario.nome }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">E-mail:</span>
                <span class="info-value">{{ pedido.usuario.email }}</span>
            </div>
            {% if pedido.usuario.telefone %}
            <div class="info-row">
                <span class="info-label">Telefone:</span>
                <span class="info-value">{{ pedido.usuario.telefone }}</span>
            </div>
            {% endif %}
            {% if pedido.usuario.get_endereco_formatado() %}
            <div class="info-row">
                <span class="info-label">Endereço:</span>
                <span class="info-value">{{ pedido.usuario.get_endereco_formatado() }}</span>
            </div>
            {% endif %}
            <div class="info-row">
                <span class="info-label">Cliente desde:</span>
                <span class="info-value">{{ pedido.usuario.data_criacao.strftime('%d/%m/%Y') }}</span>
            </div>
        </div>
    </div>

    <!-- Itens do Pedido -->
    <div class="order-items-card">
        <div class="card-header">
            <h3><i class="fas fa-shopping-cart"></i> Itens do Pedido</h3>
        </div>
        <div class="card-content">
            {% for item in pedido.itens %}
            <div class="order-item">
                <div class="item-image">
                    {% if item.doce.imagem_url %}
                   <img src="{{ asset_url(item.doce.imagem_url) }}" 
                         alt="{{ item.doce.nome }}" class="product-thumb">
                    {% else %}
                    <div class="product-thumb-placeholder">
                        <i class="fas fa-birthday-cake"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="item-details">
                    <h4 class="item-name">{{ item.doce.nome }}</h4>
                    {% if item.sabor_selecionado %}
                    <div class="item-selected-flavor">
                        <span class="flavor-label">Sabor escolhido:</span>
                        <span class="flavor-tag selected">{{ item.sabor_selecionado }}</span>
                    </div>
                    {% elif item.doce.sabores %}
                    <div class="item-flavors">
                        <span class="flavor-label">Sabores disponíveis:</span>
                        {% for sabor in item.doce.get_sabores_list() %}
                        <span class="flavor-tag">{{ sabor }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <div class="item-specs">
                        <span class="item-quantity">{{ item.quantidade }}x</span>
                        <span class="item-unit-price">R$ {{ "%.2f"|format(item.preco_unitario) }} cada</span>
                    </div>
                </div>
                <div class="item-total">
                    <span class="total-amount">R$ {{ "%.2f"|format(item.preco_total) }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Resumo Financeiro -->
    <div class="order-summary-card">
        <div class="card-header">
            <h3><i class="fas fa-calculator"></i> Resumo Financeiro</h3>
        </div>
        <div class="card-content">
            <div class="summary-row">
                <span>Subtotal:</span>
                <span>R$ {{ "%.2f"|format(pedido.total) }}</span>
            </div>
            <div class="summary-row">
                <span>Taxa de Entrega:</span>
                <span>A combinar</span>
            </div>
            <div class="summary-row total">
                <span>Total:</span>
                <span>R$ {{ "%.2f"|format(pedido.total) }}</span>
            </div>
        </div>
    </div>

    <!-- Atualizar Status -->
    {% if pedido.status != 'cancelado' and pedido.status != 'concluido' %}
    <div class="status-update-card">
        <div class="card-header">
            <h3><i class="fas fa-edit"></i> Atualizar Status</h3>
        </div>
        <div class="card-content">
            <form method="POST" action="{{ url_for('admin.atualizar_status_pedido', pedido_id=pedido.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-group">
                    <label for="status">Novo Status:</label>
                    <select name="status" id="status" class="form-control">
                        <option value="pendente" {% if pedido.status == 'pendente' %}selected{% endif %}>Pendente</option>
                        <option value="preparando" {% if pedido.status == 'preparando' %}selected{% endif %}>Preparando</option>
                        <option value="pronto" {% if pedido.status == 'pronto' %}selected{% endif %}>Pronto</option>
                        <option value="entregando" {% if pedido.status == 'entregando' %}selected{% endif %}>Entregando</option>
                        <option value="concluido" {% if pedido.status == 'concluido' %}selected{% endif %}>Concluído</option>
                        <option value="cancelado" {% if pedido.status == 'cancelado' %}selected{% endif %}>Cancelado</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Atualizar Status
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Status Timeline -->
    <div class="order-timeline-card">
        <div class="card-header">
            <h3><i class="fas fa-history"></i> Histórico do Pedido</h3>
        </div>
        <div class="card-content">
            <div class="timeline">
                <div class="timeline-item active">
                    <div class="timeline-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Pedido Realizado</h4>
                        <p>{{ pedido.data_pedido.strftime('%d/%m/%Y às %H:%M') }}</p>
                    </div>
                </div>
                
                {% if pedido.status != 'pendente' %}
                <div class="timeline-item active">
                    <div class="timeline-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Em Preparação</h4>
                        <p>Pedido em preparação</p>
                    </div>
                </div>
                {% endif %}
                
                {% if pedido.status in ['pronto', 'entregando', 'concluido'] %}
                <div class="timeline-item active">
                    <div class="timeline-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Pronto</h4>
                        <p>Pedido pronto para entrega</p>
                    </div>
                </div>
                {% endif %}
                
                {% if pedido.status in ['entregando', 'concluido'] %}
                <div class="timeline-item active">
                    <div class="timeline-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Em Entrega</h4>
                        <p>Pedido a caminho</p>
                    </div>
                </div>
                {% endif %}
                
                {% if pedido.status == 'concluido' %}
                <div class="timeline-item active">
                    <div class="timeline-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Entregue</h4>
                        <p>Pedido entregue com sucesso!</p>
                    </div>
                </div>
                {% endif %}
                
                {% if pedido.status == 'cancelado' %}
                <div class="timeline-item cancelled">
                    <div class="timeline-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Cancelado</h4>
                        <p>Pedido cancelado</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Ações do Pedido -->
<div class="order-actions">
    <a href="{{ url_for('admin.listar_pedidos') }}" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i>
        Voltar aos Pedidos
    </a>
    
    {% if pedido.usuario.telefone %}
    {% set telefone_limpo = pedido.usuario.telefone|replace('(', '')|replace(')', '')|replace(' ', '')|replace('-', '')|replace('+', '')|replace('.', '') %}
    {% if telefone_limpo[:2] == '55' %}
        {% set whatsapp_numero = telefone_limpo %}
    {% else %}
        {% set whatsapp_numero = '55' + telefone_limpo %}
    {% endif %}
    <a href="https://wa.me/{{ whatsapp_numero }}" target="_blank" class="btn btn-success">
        <i class="fab fa-whatsapp"></i>
        Contatar Cliente
    </a>
    {% endif %}
    
    <a href="mailto:{{ pedido.usuario.email }}" class="btn btn-info">
        <i class="fas fa-envelope"></i>
        Enviar E-mail
    </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Animação dos cards
const cards = document.querySelectorAll('.order-info-card, .customer-info-card, .order-items-card, .order-summary-card, .status-update-card, .order-timeline-card');
cards.forEach((card, index) => {
    setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
    }, index * 100);
});

// Adicionar animação inicial
cards.forEach(card => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'all 0.3s ease';
});
</script>
{% endblock %}
